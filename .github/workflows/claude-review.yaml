name: claude-review
# Runner versions pinned; see ci.yaml header comment for rationale.

# Two modes in one job:
# - pull_request_target: automatic code review on non-draft PRs.
# - pull_request_review: respond to formal reviews on bot-authored PRs.
on:
  pull_request_target:
    types: [opened, synchronize, ready_for_review, reopened]
  pull_request_review:
    types: [submitted]

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  CLICOLOR_FORCE: 1
  RUSTFLAGS: "-C debuginfo=0"
  RUSTDOCFLAGS: "-Dwarnings"

jobs:
  claude:
    if: |
      (github.event_name == 'pull_request_target' &&
        github.event.pull_request.draft == false) ||
      (github.event_name == 'pull_request_review' &&
        github.event.pull_request.user.login == 'worktrunk-bot' &&
        github.event.review.user.login != 'worktrunk-bot' &&
        (github.event.review.state != 'approved' || github.event.review.body))
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: ðŸ“‚ Checkout merge commit (initial review)
        if: github.event_name == 'pull_request_target'
        uses: actions/checkout@v6
        with:
          ref: refs/pull/${{ github.event.pull_request.number }}/merge
          fetch-depth: 0
          token: ${{ secrets.WORKTRUNK_BOT_TOKEN }}

      - name: ðŸ“‚ Checkout code (review response)
        if: github.event_name == 'pull_request_review'
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true
          token: ${{ secrets.WORKTRUNK_BOT_TOKEN }}

      - name: ðŸ”§ Configure git for Claude
        run: |
          git config --global user.name "Claude Code"
          git config --global user.email "claude@anthropic.com"

      - name: ðŸ“Œ Check out PR branch
        if: github.event_name == 'pull_request_review'
        run: gh pr checkout ${{ github.event.pull_request.number }}
        env:
          GH_TOKEN: ${{ secrets.WORKTRUNK_BOT_TOKEN }}

      - name: Install cargo-insta
        if: github.event_name == 'pull_request_review'
        uses: baptiste0928/cargo-install@v3
        with:
          crate: cargo-insta

      - name: Install cargo-nextest
        if: github.event_name == 'pull_request_review'
        uses: baptiste0928/cargo-install@v3
        with:
          crate: cargo-nextest

      - name: ðŸ’° Cache
        if: github.event_name == 'pull_request_review'
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: ${{ hashFiles('Cargo.lock') }}
          save-if: false

      - name: Install shells (zsh, fish)
        if: github.event_name == 'pull_request_review'
        run: |
          sudo apt-get update
          sudo apt-get install -y zsh fish

      - name: ðŸ¤– Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.WORKTRUNK_BOT_TOKEN }}
          additional_permissions: |
            actions: read
          use_sticky_comment: ${{ github.event_name == 'pull_request_target' }}
          prompt: ${{ github.event_name == 'pull_request_target' && format('Use /pr-review {0}', github.event.pull_request.number) || '' }}
          claude_args: |
            --model opus
            --allowedTools Bash,Edit,Read,Write,Glob,Grep,WebSearch,WebFetch,Task,Skill
            --append-system-prompt "You are operating in a GitHub Actions CI environment. Use /running-in-ci before starting work."

      - name: ðŸ“‹ Upload Claude Code session logs
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: claude-session-logs
          path: /home/runner/.claude/projects/
          retention-days: 30
          if-no-files-found: warn
