name: claude-renovate

# Weekly renovation check - reviews CI dependencies and creates PRs for updates
on:
  schedule:
    # Run at 9:17 AM UTC every Sunday (off-peak minute)
    - cron: '17 9 * * 0'
  workflow_dispatch:

# Consistent with ci.yaml for cache compatibility
env:
  CARGO_TERM_COLOR: always
  CLICOLOR_FORCE: 1
  RUSTFLAGS: "-C debuginfo=0"
  RUSTDOCFLAGS: "-Dwarnings"

jobs:
  renovate:
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      pull-requests: write
      actions: read
      id-token: write
    steps:
      - name: ðŸ“‚ Checkout code
        uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 0
          fetch-tags: true
          token: ${{ secrets.WORKTRUNK_BOT_TOKEN }}

      - name: ðŸ”§ Configure git for Claude
        run: |
          git config --global user.name "Claude Code"
          git config --global user.email "claude@anthropic.com"

      - name: ðŸ’° Cache
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: ${{ hashFiles('Cargo.lock') }}
          save-if: false

      - name: ðŸ¤– Run Claude Code for renovation
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.WORKTRUNK_BOT_TOKEN }}
          additional_permissions: |
            actions: read

          prompt: |
            You are running as part of a weekly renovation workflow. Your job is to check for updates to CI dependencies and create PRs if updates are available.

            ## What to check

            1. **GitHub Actions runner versions**:
               - Check what the current `-latest` labels resolve to:
                 - `ubuntu-latest` - what Ubuntu version?
                 - `macos-latest` - what macOS version?
                 - `windows-latest` - what Windows version?
               - Compare against what we have pinned in our workflow files
               - Note: `windows-latest` has D: drive issues (actions/runner-images#12677), so stay on windows-2022

            2. **GitHub Actions versions**:
               - Check for updates to actions we use (actions/checkout, actions/cache, etc.)
               - Look at the current versions in .github/workflows/*.yaml
               - Check if newer versions are available

            3. **Rust nightly version** (in check-unused-dependencies job):
               - We pin a specific nightly for cargo-udeps (check the actual version in ci.yaml)
               - Periodically update to a recent nightly that works with cargo-udeps

            4. **Pinned cargo tool versions**:
               - All cargo tools are pinned with `version: "=X.Y.Z"` in workflow files to prevent surprise breakage from MSRV bumps
               - Check if newer versions are available for: cargo-nextest, cargo-insta, lychee, worktrunk, cargo-msrv, cargo-udeps, cargo-llvm-cov
               - To check: look up the tool's MSRV on crates.io or its repo and compare against the channel in `rust-toolchain.toml`
               - Only update the pin if the new version is compatible with our rustc
               - Update pins in ALL workflow files that use the tool (ci.yaml and claude-*.yaml)

            ## How to check

            - Use `gh api` and web searches to find current versions
            - Read our workflow files to see what we currently use
            - Check the actions/runner-images repository for runner version info
            - Check individual action repos for version updates

            ## If updates are available

            1. Create a new branch: `git checkout -b chore/renovate-$(date +%Y%m%d)`
            2. Make the updates to workflow files
            3. Commit with a clear message explaining what was updated
            4. Push and create a PR with:

            ```
            ## Summary
            Weekly CI renovation check found the following updates:

            - [List each update]

            ## Changes
            - [Describe each change]

            ## Notes
            - [Any caveats or things to watch for]

            ---
            ðŸ¤– Automated weekly renovation
            ```

            ## If no updates are needed

            Simply report that all dependencies are up to date. Don't create a PR.

          claude_args: |
            --model opus
            --allowedTools Bash,Edit,Read,Write,Glob,Grep,WebSearch,WebFetch,Task,Skill
            --append-system-prompt "You are operating in a GitHub Actions CI environment. Use /running-in-ci before starting work."

      - name: ðŸ“‹ Upload Claude Code session logs
        if: always()
        uses: actions/upload-artifact@v7
        with:
          name: claude-session-logs
          path: /home/runner/.claude/projects/
          retention-days: 30
          if-no-files-found: warn
