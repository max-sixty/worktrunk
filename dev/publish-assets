#!/bin/bash
# Publish demo assets to the worktrunk-assets repo
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(dirname "$SCRIPT_DIR")"
ASSETS_REPO="$REPO_ROOT/../worktrunk-assets"
DEMOS_DIR="$REPO_ROOT/docs/static/assets"

# Clone assets repo if needed
if [[ ! -d "$ASSETS_REPO/.git" ]]; then
    if ! command -v gh &>/dev/null; then
        echo "Error: gh CLI required. Install from https://cli.github.com/"
        exit 1
    fi
    echo "Cloning assets repo..."
    if ! gh repo clone max-sixty/worktrunk-assets "$ASSETS_REPO"; then
        echo "Failed to clone assets repo"
        exit 1
    fi
fi

# Update assets repo
cd "$ASSETS_REPO"
if ! git pull --ff-only; then
    echo "Failed to update assets repo. Check for uncommitted changes."
    exit 1
fi

# Copy demo assets
if [[ -d "$DEMOS_DIR/docs" ]] && [[ -n "$(ls -A "$DEMOS_DIR/docs" 2>/dev/null)" ]]; then
    rsync -av --delete "$DEMOS_DIR/docs/" "$ASSETS_REPO/demos/docs/"
fi

# Copy social card assets
if [[ -d "$DEMOS_DIR/social" ]] && [[ -n "$(ls -A "$DEMOS_DIR/social" 2>/dev/null)" ]]; then
    rsync -av --delete "$DEMOS_DIR/social/" "$ASSETS_REPO/social/"
fi

# Check for changes
if git diff --quiet; then
    echo "No changes to publish"
    exit 0
fi

# Commit and push
git diff --stat
git add -A
git commit -m "Update assets"
git push

echo ""
echo "Published: https://github.com/max-sixty/worktrunk-assets"
