#!/usr/bin/env bash
# Regenerate social card ONGs from SVG sources
# Requires: rsvg-convert (from librsvg)
# Fonts are downloaded automatically if not installed

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
STATIC_DIR="$SCRIPT_DIR/../docs/static"
OUTPUT_DIR="$STATIC_DIR/assets/social"
FONT_DIR="$SCRIPT_DIR/../.fonts"

# Download font from Google Fonts if not installed
ensure_font() {
    local name="$1"
    local url="$2"

    if fc-list | grep -qi "$name"; then
        return 0
    fi

    echo "Downloading $name..."
    mkdir -p "$FONT_DIR"
    local zip="$FONT_DIR/${name// /_}.zip"
    curl -sL "$url" -o "$zip"
    unzip -qo "$zip" -d "$FONT_DIR"
    rm "$zip"
}

# Font sources (GitHub releases)
ensure_font "Inter" "https://github.com/rsms/inter/releases/download/v4.1/Inter-4.1.zip"
ensure_font "Plus Jakarta Sans" "https://github.com/tokotype/PlusJakartaSans/releases/download/2.7.1/PlusJakartaSans-2.7.1.zip"

# Create fontconfig that includes our downloaded fonts
export FONTCONFIG_FILE="$FONT_DIR/fonts.conf"
cat > "$FONT_DIR/fonts.conf" << EOF
<?xml version="1.0"?>
<!DOCTYPE fontconfig SYSTEM "urn:fontconfig:fonts.dtd">
<fontconfig>
  <dir>$FONT_DIR</dir>
  <cachedir>$FONT_DIR/cache</cachedir>
  <include ignore_missing="yes">/etc/fonts/fonts.conf</include>
</fontconfig>
EOF
mkdir -p "$FONT_DIR/cache"

# Rebuild font cache
fc-cache -f "$FONT_DIR" 2>/dev/null

# Verify fonts are available
for font in "Inter" "Plus Jakarta Sans"; do
    if ! fc-list : family | grep -qi "$font"; then
        echo "Error: Font '$font' not found after download" >&2
        exit 1
    fi
done

mkdir -p "$OUTPUT_DIR"
cd "$STATIC_DIR"
echo "Building social cards..."

# Open Graph card (1200x630)
rsvg-convert social-card.svg -o "$OUTPUT_DIR/social-card.png"

# GitHub card (1280x640)
rsvg-convert github-social-card.svg -o "$OUTPUT_DIR/github-social-card.png"

echo "Done:"
ls -lh "$OUTPUT_DIR"/*.png
